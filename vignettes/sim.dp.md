---
title: "Simulation of Dissolution Profiles"
author: "Zhengguo XU"
date: "2021-07-26"
output: 
  rmarkdown::html_vignette:
    keep_md: true
    toc: true
    toc_depth: 3
    fig_width: 7
    fig_height: 4.5
  highlight: "tango"
bibliography: ref.bib
notes-after-punctuation: false
link-citations: yes
csl: ref.csl
vignette: >
  %\VignetteIndexEntry{Simulation of Dissolution Profiles}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---





## Introduction

Dissolution profiles are simulated either by mathematical models, or
by multivariate normal distribution based on function `mvrnorm()` from
R package `MASS`.

### Mathematical Models

Two models are implemented at the moment: *first-order* model and 
*Weibull* model (the default). 

The first-order model is expressed as 

$$f_t = f_\mathrm{max}\left(1 - e^{-k\cdot (t - t_\mathrm{lag})}\right),$$
and the Weibull model either as
$$f_t = f_\mathrm{max}\left(1 - e^{-\left(\frac{t - t_\mathrm{lag}}
  {\mathrm{MDT}}\right)^\beta}\right),$$
or as 
$$f_t = f_\mathrm{max}\left(1 - e^{-\frac{\left(t - t_\mathrm{lag}\right)^\beta}
  {\alpha}}\right).$$
Obviously, the two expressions of Weibull model are mathematically equivalent
with $\alpha = \mathrm{MDT}^\beta$. 

Parameter $f_\mathrm{max}$ is the maximum dissolution. In theory, it is 100,
but in practice, it might be slightly high than 100, or much less if the
dissolution is not complete. For immediate-release formulation, the lag time
$t_\mathrm{lag}$ is typically zero, but not necessary so for the extended
release formulation. Parameter $k$ is the first-order rate constant, and
$\alpha$ and $\beta$ are scale and shape parameters, and $\mathrm{MDT}$ is
the mean dissolution time.


### Simulation based on mathematical models

Let $P_\mu$ be the set of *population* model parameters, i.e., 
$P_\mu = \{f_\mathrm{max}, k, t_\mathrm{lag}\}$ for the first-order 
model and $P_\mu = \{f_\mathrm{max}, t_\mathrm{lag}, \mathrm{MDT}, \beta\}$
or $P_\mu = \{f_\mathrm{max}, t_\mathrm{lag}, \alpha, \beta\}$ for Weibull
model, given any time points `tp`, the dissolution profile $f_t$
will be calculated according to the equations above with parameters $P_\mu$.
The generated profile is considered as *population* dissolution profile `dp`. 

Individual dissolution profiles are generated with the same equation, 
but with individual model parameters $P_i$, which is simulated according to
exponential error model 
$$P_i = P_\mu \cdot e^{N\left(0,\, \sigma^2\right)},$$
where $N\left(0,\, \sigma^2\right)$ represents the normal distribution 
with mean zero and variance $\sigma^2$ ($\sigma = \mathrm{CV}/100$)

### Simulation based on multivariate normal distribution

Note that the *population* dissolution profile `dp` in the previous section
is generated by equation with *population* model parameters $P_\mu$. 
Sometime we might have a mean dissolution profile `dp`, which is considered
as population profile, and we want to simulate many individual profiles 
such that the calculated mean profile is equal to `dp`. In such case, 
multivariate normal distribution approach will be used. Given any `tp`, 
`dp`, and the required number of individual units `n.units`, the function 
will simulate individual profiles fulfil the above mentioned requirements.

### Recommendation

*Depending on the variability and the target profile, the run time of
simulation based on multivariate normal distribution might be very long,
sometimes it might even fail to finish. So in general, the modelling 
approach is recommended.*

## Usage

The complete list of arguments of the function is as follows:


```r
sim.dp(tp, model = c("Weibull", "first-order"), model.par,
       seed, product, dp, dp.cv, ascending = FALSE, n.units = 12L,
       max.disso = 105, message = FALSE, plot = TRUE,
       time.unit = c("min", "h"), plot.max.unit = 36L)
```

### Notes on function arguments

1. Time points `tp` is mandatory. You should supplied it as a numeric 
   vector, such as `tp = c(5, 10, 15, 20, 30, 45, 60)`. The rest 
   arguments will either be generated randomly or take default values.
   So the simplest usage of the function is just to run `dat <- sim.dp(tp)` 
   as many time as you need. Each time it will simulated different set of 
   dissolution profiles, and print mean and individual plots. You can stop
   until you find what you like (e.g., the shape of the curve).
2. If `dp` is missing, then mathematical model will be used; if not, 
   then multivariate normal distribution approach will be used.
3. Model parameter `model.par` has to be specified as named list, e.g., 
   `list(fmax = 100, fmax.cv = 3, tlag = 0, tlag.cv = 0, k = 0.9, k.cv = 30)`.
   The parameter `fmax/k/tlag` are used to generate `dp`, and the
   corresponding `.cv` parts are used to generate individual model 
   parameters. If `model.par` is missing, it will be generated randomly.
4. When `dp` is provided, in general, `dp.cv` should also be provided to 
   indicate the desired variability at each time points. If missing, 
   it will be generated such that the CV is 20% up to 10 min, and 10% 
   for the rest, unless there are time points where the dissolution are
   more than 90%, in which case, the CV is 5%. 
5. When multivariate normal distribution approach is used, depending on
   the target profile and the variability, sometimes the simulated 
   individual profiles will *decrease* in the end. This could also 
   happen to the real-life profiles, especially for those products
   that are unstable in the dissolution media. To force the profiles
   *always increase* with time, set option `ascending = TRUE`. However,
   in that case, it is possible that the function takes long time to run
   or even stop working. 
   without the possibility of finishing
6. Parameter `product` is not really necessary for the simulation. so
   if missing, it will be generated automatically with 3 letters and 
   4 digits. It might be useful in the situations such as many 
   simulation will be run and output are pooled together for analysis.
7. Read the function manual by `help("sim.dp")` for more details on 
   each argument. 
 

## Examples

### Simple case

If you just want a set of dissolution profiles, e.g., to test program
coding, only `tp` is necessary.
 

```r
# time points
tp <- c(5, 10, 15, 20, 30, 45, 60)
# simulation
tmp1 <- sim.dp(tp)
```

The output a list of 5 components:

1. `sim.info`: a data frame with information of the simulation. With this
information available, the result can be reproduced if necessary.


```r
tmp1$sim.info
#    fmax fmax.cv  mdt mdt.cv     beta beta.cv tlag tlag.cv       seed n.units
# 1 97.87       3 6.73     30 0.980058      20    0       0 1531823704      12
#   max.disso   model time.unit
# 1       105 Weibull       min
```

2. `sim.summary`: a data frame with summary statistics of the simulated
   profiles.


```r
tmp1$sim.summary
#   product time       dp dp.cv sim.mean sim.median    sim.cv   sim.var   sim.sd
# 1 DEY4007    0  0.00000    NA  0.00000    0.00000  0.000000  0.000000 0.000000
# 2 DEY4007    5 51.51716    NA 56.51926   57.72625 14.694173 68.973645 8.305037
# 3 DEY4007   10 75.46142    NA 78.79325   78.58501  9.957547 61.557754 7.845875
# 4 DEY4007   15 86.95482    NA 88.29032   88.88227  6.576092 33.710243 5.806052
# 5 DEY4007   20 92.52735    NA 92.64151   93.16314  4.247493 15.483765 3.934942
# 6 DEY4007   30 96.57710    NA 95.97758   95.73666  2.273830  4.762725 2.182367
# 7 DEY4007   45 97.71342    NA 97.24027   97.41268  1.959319  3.629968 1.905247
# 8 DEY4007   60 97.85077    NA 97.51116   97.50663  1.975963  3.712498 1.926784
#    sim.min   sim.max sim.qt05 sim.qt25 sim.qt75  sim.qt95
# 1  0.00000   0.00000  0.00000  0.00000  0.00000   0.00000
# 2 39.00013  69.89519 44.14720 52.13424 62.35782  66.50729
# 3 62.59356  91.13186 67.42005 73.86682 83.72019  89.36271
# 4 76.69920  96.79637 80.23493 83.94620 92.24589  95.87484
# 5 85.10257  98.23643 86.73442 89.97163 96.17212  97.48912
# 6 92.49944  99.75155 92.80993 94.72484 97.34780  99.16048
# 7 94.42153 101.17281 94.44249 96.22170 98.05781  99.81435
# 8 94.42169 101.47920 94.71019 96.75966 98.49306 100.05802
```
`dp` is the population mean profile obtained with the parameters in 
`sim.info`, as explained in previous section. The rest columns with prefix
`sim` are basic descriptive statistics calculated from all simulated
individual profiles. `sim.qt05`, `sim.qt25`, ..., are 5%, 25%, .., quantiles.

3. `sim.disso`: a data frame of dissolution profiles that has the correct
   format to be used as the input for the function `calcf2()`. 

```r
tmp1$sim.disso
#   time   unit.01  unit.02  unit.03  unit.04  unit.05  unit.06  unit.07  unit.08
# 1    0   0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
# 2    5  63.73537 62.32079 59.18695 48.35844 39.00013 55.12999 53.14504 56.26555
# 3   10  83.00827 85.85594 81.01553 71.36899 62.59356 73.92410 73.69498 77.93229
# 4   15  91.73951 93.76504 89.61446 83.47867 76.69920 83.12780 84.10204 88.15009
# 5   20  96.12484 96.31397 93.07363 90.04103 85.10257 88.06958 89.76344 93.25264
# 6   30  99.75155 97.35986 95.06262 95.67726 93.06396 92.49944 94.83933 97.27884
# 7   45 101.17281 97.46326 95.44440 97.82595 96.48080 94.45964 97.03284 98.65987
# 8   60 101.47920 97.46591 95.47253 98.22871 97.18871 94.94623 97.54735 98.89523
#    unit.09  unit.10  unit.11  unit.12
# 1  0.00000  0.00000  0.00000  0.00000
# 2 69.89519 59.62289 62.46892 49.10182
# 3 91.13186 77.84053 87.91523 79.23774
# 4 96.79637 86.65412 95.12087 90.23567
# 5 98.23643 91.41837 96.87768 93.42400
# 6 98.67687 95.79607 97.34378 94.38135
# 7 98.70288 97.85713 97.36210 94.42153
# 8 98.70319 98.42302 97.36219 94.42169
```

4. `model.par.ind`: a data frame of individual model parameters that are
   used to simulate the individual dissolution profiles. 

```r
tmp1$model.par.ind
#     fmax.ind  mdt.ind  beta.ind tlag.ind
# 1  101.58019 5.081907 0.7832140        0
# 2   97.46597 4.907444 1.0606585        0
# 3   95.47485 5.174950 0.9643424        0
# 4   98.32697 7.590249 0.9348339        0
# 5   97.37235 9.715541 1.0086159        0
# 6   95.13713 5.992666 0.7927647        0
# 7   97.72790 6.676677 0.8378047        0
# 8   98.94881 6.086616 0.8817834        0
# 9   98.70319 4.108439 1.0601288        0
# 10  98.68734 5.536476 0.7464452        0
# 11  97.36219 4.892264 1.1847953        0
# 12  94.42170 6.324318 1.3159950        0
```

5. `sim.plot`: a plot since the default argument `plot` is set to be `TRUE`.


```r
tmp1$sim.plot
```

![](/home/zhengguo/github/bootf2/vignettes/sim.dp_files/figure-html/simple01-plot-1.png)<!-- -->

When the number of individual units is not large, all individual profiles
will be plotted, together with the population profile in green (as target
profile), and mean profile in blue calculated with simulated individual 
profiles. When the number is small, there will be visible difference 
between the mean and the target profile due to random error. When the
number of units increase, the difference will become smaller. 

The argument `plot.max.unit` control how individual profile will be 
represented in the plot. When the actual number of units is greater than 
the value of `plot.max.unit`, the individual profile will be represented as 
boxplots at each time points, as shown below.


```r
# default plot.max.unit = 36
sim.dp(tp, n.units = 100)$sim.plot
```

![](/home/zhengguo/github/bootf2/vignettes/sim.dp_files/figure-html/simple01-boxplot-1.png)<!-- -->

### Example with model parameters

To obtain precise simulation, model parameters should be provided. 
CV should be specified in percentage.


```r
fo.par <- list(fmax = 100, fmax.cv = 3, k = 0.1, k.cv = 20, 
               tlag = 0, tlag.cv = 0)
fo.dat <- sim.dp(tp, model = "first-order", model.par = fo.par, seed = 123)
fo.dat$sim.plot
```

![](/home/zhengguo/github/bootf2/vignettes/sim.dp_files/figure-html/model01-dat-1.png)<!-- -->

```r
fo.dat$sim.summary
#   product time       dp dp.cv  sim.mean sim.median    sim.cv   sim.var   sim.sd
# 1 WUG8988    0  0.00000    NA   0.00000    0.00000  0.000000  0.000000 0.000000
# 2 WUG8988    5 39.34693    NA  38.52706   37.66587 14.906863 32.984076 5.743176
# 3 WUG8988   10 63.21206    NA  61.97200   61.37592 11.035730 46.772788 6.839063
# 4 WUG8988   15 77.68698    NA  76.37079   76.30466  8.085150 38.126828 6.174693
# 5 WUG8988   20 86.46647    NA  85.28987   85.29433  5.900152 25.323360 5.032232
# 6 WUG8988   30 95.02129    NA  94.36188   94.60488  3.334616  9.901130 3.146606
# 7 WUG8988   45 98.88910    NA  98.90256   99.35504  2.410309  5.682777 2.383858
# 8 WUG8988   60 99.75212    NA 100.11487  100.22436  2.536687  6.449571 2.539601
#    sim.min   sim.max sim.qt05 sim.qt25  sim.qt75  sim.qt95
# 1  0.00000   0.00000  0.00000  0.00000   0.00000   0.00000
# 2 30.06994  51.17872 31.43284 35.06597  41.49757  47.42573
# 3 51.52844  76.22018 53.04270 57.72632  65.57302  72.41771
# 4 66.84165  88.47281 67.91555 72.79464  79.54105  85.65132
# 5 77.76945  94.46796 78.16294 82.52326  87.80567  92.69191
# 6 89.27668  98.83663 89.67045 92.59967  96.96180  98.47507
# 7 94.67076 102.91822 95.05811 97.52264 100.24309 101.90983
# 8 95.86586 104.29887 96.59454 98.31322 101.70735 103.67720
```
Similarly, for Weibull model, the model parameter should be provided like
the example below. The order of the parameter does not matter, but the
parameter names have to be specified exactly as the following:

```r
# with alpha = xx and alpha.cv = yy to replace beta/beta.cv if alternative
# expression of Weibull model is used.
mod.par <- list(fmax = 100, fmax.cv = 3, tlag = 0, tlag.cv = 0, 
                mdt = 20, mdt.cv = 25, beta = 2, beta.cv = 30)
```


### Example with multivariate normal distribution


```r
# target mean profile 
dp <- c(39, 63, 77, 86, 95, 98, 100)

# CV at each time points
dp.cv <- c(19, 15, 10, 8, 8, 5, 3)

mvn.dat <- sim.dp(tp, dp = dp, dp.cv = dp.cv, seed = 123)
mvn.dat$sim.summary
#   product time  dp dp.cv sim.mean sim.median sim.cv sim.var sim.sd  sim.min
# 1 JEF8447    0   0     0        0    0.00000      0  0.0000   0.00  0.00000
# 2 JEF8447    5  39    19       39   38.91467     19 54.9081   7.41 23.54978
# 3 JEF8447   10  63    15       63   62.89118     15 89.3025   9.45 43.29627
# 4 JEF8447   15  77    10       77   76.91134     10 59.2900   7.70 60.94511
# 5 JEF8447   20  86     8       86   85.92078      8 47.3344   6.88 71.65485
# 6 JEF8447   30  95     8       95   94.91249      8 57.7600   7.60 79.15362
# 7 JEF8447   45  98     5       98   97.94358      5 24.0100   4.90 87.78325
# 8 JEF8447   60 100     3      100   99.96546      3  9.0000   3.00 93.74485
#     sim.max sim.qt05 sim.qt25  sim.qt75  sim.qt95
# 1   0.00000  0.00000  0.00000   0.00000   0.00000
# 2  47.95348 27.86289 35.29602  45.14930  47.19688
# 3  74.41840 48.79680 58.27630  70.84223  73.45351
# 4  86.30388 65.42703 73.15106  83.38996  85.51768
# 5  94.31308 75.65947 82.56094  91.70947  93.61060
# 6 104.18305 83.57732 91.20104 101.30698 103.40706
# 7 103.92065 90.63538 95.55067 102.06634 103.42034
# 8 103.62489 95.49105 98.50041 102.48960 103.31858
```
Notice that the the mean and CV of the simulated individual profile (
`sim.mean` and `sim.cv`) are equal to the target profile `dp` and `dp.cv`.
The plot look like this:


```r
mvn.dat$sim.plot
```

![](/home/zhengguo/github/bootf2/vignettes/sim.dp_files/figure-html/mvn01-plot-1.png)<!-- -->

Another example with missing `dp.cv`.

```r
mvn.dat2 <- sim.dp(tp, dp = dp, seed = 100)
mvn.dat2$sim.summary
#   product time  dp dp.cv sim.mean sim.median sim.cv  sim.var sim.sd  sim.min
# 1 IXU5306    0   0     0        0    0.00000      0   0.0000   0.00  0.00000
# 2 IXU5306    5  39    20       39   40.85072     20  60.8400   7.80 20.52713
# 3 IXU5306   10  63    20       63   65.98962     20 158.7600  12.60 33.15922
# 4 IXU5306   15  77    10       77   78.82699     10  59.2900   7.70 58.76397
# 5 IXU5306   20  86    10       86   88.04054     10  73.9600   8.60 65.63248
# 6 IXU5306   30  95     5       95   96.12704      5  22.5625   4.75 83.75050
# 7 IXU5306   45  98     5       98   99.16263      5  24.0100   4.90 86.39525
# 8 IXU5306   60 100     5      100  101.18636      5  25.0000   5.00 88.15842
#     sim.max sim.qt05 sim.qt25  sim.qt75  sim.qt95
# 1   0.00000  0.00000  0.00000   0.00000   0.00000
# 2  46.38547 26.32554 35.73099  44.96153  46.33789
# 3  74.93037 42.52587 57.71929  72.63016  74.85351
# 4  84.29078 64.48803 73.77290  82.88510  84.24381
# 5  94.14295 72.02560 82.39570  92.57297  94.09049
# 6  99.49756 87.28158 93.00926  98.63042  99.46858
# 7 102.63959 90.03784 95.94639 101.74506 102.60970
# 8 104.73427 91.87535 97.90448 103.82149 104.70377
```
Notice that the CVs were generated automatically as explained in
[Notes on function arguments].

As [explained above][Notes on function arguments], sometimes the
profiles will *decrease* toward the end, especially when the target 
profile is fast and the variability is high. 


```r
dp.fast <- c(50, 74, 84, 87, 92, 97, 99)
dp2.cv <- c(15, 15, 10, 10, 10, 10, 5)
tmp2 <- sim.dp(tp, dp = dp.fast, dp.cv = dp2.cv, seed = 123)
tmp2$sim.plot
```

![](/home/zhengguo/github/bootf2/vignettes/sim.dp_files/figure-html/mvn03-dat-1.png)<!-- -->
Notice the downward trend from 45 min to 60 min for some individual 
profiles. Check the individual values for unit 1, 2, 5, 6, etc. 



```r
tmp2$sim.disso
#   time   unit.01   unit.02  unit.03  unit.04   unit.05   unit.06   unit.07
# 1    0   0.00000   0.00000  0.00000  0.00000   0.00000   0.00000   0.00000
# 2    5  55.82662  55.20252 48.48971 30.95455  55.20004  55.71012  54.24746
# 3   10  82.62340  81.69973 71.76478 45.81273  81.69606  82.45097  80.28624
# 4   15  90.52582  89.82682 82.30848 62.66909  89.82405  90.39533  88.75715
# 5   20  93.75888  93.03493 85.24807 64.90728  93.03205  93.62374  91.92705
# 6   30  99.14732  98.38176 90.14738 68.63758  98.37872  99.00441  97.21022
# 7   45 104.53576 103.72860 95.04670 72.36788 103.72539 104.38508 102.49338
# 8   60 102.84557 102.43366 98.00321 86.43000 102.43203 102.76868 101.80332
#    unit.08   unit.09  unit.10  unit.11  unit.12
# 1  0.00000   0.00000  0.00000  0.00000  0.00000
# 2 50.32217  55.32470 46.48698 50.81294 41.42219
# 3 74.47681  81.88055 68.80073 75.20315 61.30483
# 4 84.36083  89.96366 80.06542 84.91050 74.39285
# 5 87.37371  93.17665 82.92490 87.94301 77.04973
# 6 92.39519  98.53163 87.69070 92.99721 81.47788
# 7 97.41667 103.88661 92.45650 98.05141 85.90603
# 8 99.21263 102.51430 96.68141 99.53654 93.33864
```


