---
title: "Simulation of Dissolution Profiles"
author: "Zhengguo XU"
date: "`r format(Sys.Date())`"
output: 
  rmarkdown::html_vignette:
    keep_md: true
    toc: true
    toc_depth: 3
    fig_width: 7
    fig_height: 4.5
  highlight: "tango"
bibliography: ref.bib
notes-after-punctuation: false
link-citations: yes
csl: ref.csl
vignette: >
  %\VignetteIndexEntry{Simulation of Dissolution Profiles}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup0, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#"
)
```

```{r setup, echo=FALSE}
library(bootf2)
```

## Introduction

Dissolution profiles are simulated either by mathematical models, or
by multivariate normal distribution based on function `mvrnorm()` from
R package `MASS`.

### Mathematical Models

Two models are implemented at the moment: *first-order* model and 
*Weibull* model (the default). 

The first-order model is expressed as 

$$f_t = f_\mathrm{max}\left(1 - e^{-k\cdot (t - t_\mathrm{lag})}\right),$$
and the Weibull model either as
$$f_t = f_\mathrm{max}\left(1 - e^{-\left(\frac{t - t_\mathrm{lag}}
  {\mathrm{MDT}}\right)^\beta}\right),$$
or as 
$$f_t = f_\mathrm{max}\left(1 - e^{-\frac{\left(t - t_\mathrm{lag}\right)^\beta}
  {\alpha}}\right).$$
Obviously, the two expressions of Weibull model are mathematically equivalent
with $\alpha = \mathrm{MDT}^\beta$. 

Parameter $f_\mathrm{max}$ is the maximum dissolution. In theory, it is 100,
but in practice, it might be slightly high than 100, or much less if the
dissolution is not complete. For immediate-release formulation, the lag time
$t_\mathrm{lag}$ is typically zero, but not necessary so for the extended
release formulation. Parameter $k$ is the first-order rate constant, and
$\alpha$ and $\beta$ are scale and shape parameters, and $\mathrm{MDT}$ is
the mean dissolution time.


### Simulation based on mathematical models

Let $P_\mu$ be the set of *population* model parameters, i.e., 
$P_\mu = \{f_\mathrm{max}, k, t_\mathrm{lag}\}$ for the first-order 
model and $P_\mu = \{f_\mathrm{max}, t_\mathrm{lag}, \mathrm{MDT}, \beta\}$
or $P_\mu = \{f_\mathrm{max}, t_\mathrm{lag}, \alpha, \beta\}$ for Weibull
model, given any time points `tp`, the dissolution profile $f_t$
will be calculated according to the equations above with parameters $P_\mu$.
The generated profile is considered as *population* dissolution profile `dp`. 

Individual dissolution profiles are generated with the same equation, 
but with individual model parameters $P_i$, which is simulated according to
exponential error model 
$$P_i = P_\mu \cdot e^{N\left(0,\, \sigma^2\right)},$$
where $N\left(0,\, \sigma^2\right)$ represents the normal distribution 
with mean zero and variance $\sigma^2$ ($\sigma = \mathrm{CV}/100$)

### Simulation based on multivariate normal distribution

Note that the *population* dissolution profile `dp` in the previous section
is generated by equation with *population* model parameters $P_\mu$. 
Sometime we might have a mean dissolution profile `dp`, which is considered
as population profile, and we want to simulate many individual profiles 
such that the calculated mean profile is equal to `dp`. In such case, 
multivariate normal distribution approach will be used. Given any `tp`, 
`dp`, and the required number of individual units `n.units`, the function 
will simulate individual profiles fulfil the above mentioned requirements.

### Recommendation

*Depending on the variability and the target profile, the run time of
simulation based on multivariate normal distribution might be very long,
sometimes it might even fail to finish. So in general, the modelling 
approach is recommended.*

## Usage

The complete list of arguments of the function is as follows:

```{r simdp-code0, eval=FALSE}
sim.dp(tp, model = c("Weibull", "first-order"), model.par,
       seed, product, dp, dp.cv, ascending = FALSE, n.units = 12L,
       max.disso = 105, message = FALSE, plot = TRUE,
       time.unit = c("min", "h"), plot.max.unit = 36L)
```

### Notes on function arguments

1. Time points `tp` is mandatory. You should supplied it as a numeric 
   vector, such as `tp = c(5, 10, 15, 20, 30, 45, 60)`. The rest 
   arguments will either be generated randomly or take default values.
   So the simplest usage of the function is just to run `dat <- sim.dp(tp)` 
   as many time as you need. Each time it will simulated different set of 
   dissolution profiles, and print mean and individual plots. You can stop
   until you find what you like (e.g., the shape of the curve).
2. If `dp` is missing, then mathematical model will be used; if not, 
   then multivariate normal distribution approach will be used.
3. Model parameter `model.par` has to be specified as named list, e.g., 
   `list(fmax = 100, fmax.cv = 3, tlag = 0, tlag.cv = 0, k = 0.9, k.cv = 30)`.
   The parameter `fmax/k/tlag` are used to generate `dp`, and the
   corresponding `.cv` parts are used to generate individual model 
   parameters. If `model.par` is missing, it will be generated randomly.
4. When `dp` is provided, in general, `dp.cv` should also be provided to 
   indicate the desired variability at each time points. If missing, 
   it will be generated such that the CV is 20% up to 10 min, and 10% 
   for the rest, unless there are time points where the dissolution are
   more than 90%, in which case, the CV is 5%. 
5. When multivariate normal distribution approach is used, depending on
   the target profile and the variability, sometimes the simulated 
   individual profiles will *decrease* in the end. This could also 
   happen to the real-life profiles, especially for those products
   that are unstable in the dissolution media. To force the profiles
   *always increase* with time, set option `ascending = TRUE`. However,
   in that case, it is possible that the function takes long time to run
   or even stop working. 
   without the possibility of finishing
6. Parameter `product` is not really necessary for the simulation. so
   if missing, it will be generated automatically with 3 letters and 
   4 digits. It might be useful in the situations such as many 
   simulation will be run and output are pooled together for analysis.
7. Read the function manual by `help("sim.dp")` for more details on 
   each argument. 
 

## Examples

### Simple case

If you just want a set of dissolution profiles, e.g., to test program
coding, only `tp` is necessary.
 
```{r simple01-dat}
# time points
tp <- c(5, 10, 15, 20, 30, 45, 60)
# simulation
tmp1 <- sim.dp(tp)
```

The output a list of 5 components:

1. `sim.info`: a data frame with information of the simulation. With this
information available, the result can be reproduced if necessary.

```{r simple01-info}
tmp1$sim.info
```

2. `sim.summary`: a data frame with summary statistics of the simulated
   profiles.

```{r simple01-summary}
tmp1$sim.summary
```
`dp` is the population mean profile obtained with the parameters in 
`sim.info`, as explained in previous section. The rest columns with prefix
`sim` are basic descriptive statistics calculated from all simulated
individual profiles. `sim.qt05`, `sim.qt25`, ..., are 5%, 25%, .., quantiles.

3. `sim.disso`: a data frame of dissolution profiles that has the correct
   format to be used as the input for the function `calcf2()`. 
```{r simple01-disso}
tmp1$sim.disso
```

4. `model.par.ind`: a data frame of individual model parameters that are
   used to simulate the individual dissolution profiles. 
```{r simple01-par}
tmp1$model.par.ind
```

5. `sim.plot`: a plot since the default argument `plot` is set to be `TRUE`.

```{r simple01-plot}
tmp1$sim.plot
```

When the number of individual units is not large, all individual profiles
will be plotted, together with the population profile in green (as target
profile), and mean profile in blue calculated with simulated individual 
profiles. When the number is small, there will be visible difference 
between the mean and the target profile due to random error. When the
number of units increase, the difference will become smaller. 

The argument `plot.max.unit` control how individual profile will be 
represented in the plot. When the actual number of units is greater than 
the value of `plot.max.unit`, the individual profile will be represented as 
boxplots at each time points, as shown below.

```{r simple01-boxplot}
# default plot.max.unit = 36
sim.dp(tp, n.units = 100)$sim.plot
```

### Example with model parameters

To obtain precise simulation, model parameters should be provided. 
CV should be specified in percentage.

```{r model01-dat}
fo.par <- list(fmax = 100, fmax.cv = 3, k = 0.1, k.cv = 20, 
               tlag = 0, tlag.cv = 0)
fo.dat <- sim.dp(tp, model = "first-order", model.par = fo.par, seed = 123)
fo.dat$sim.plot
fo.dat$sim.summary
```
Similarly, for Weibull model, the model parameter should be provided like
the example below. The order of the parameter does not matter, but the
parameter names have to be specified exactly as the following:
```{r model01-par, eval=FALSE}
# with alpha = xx and alpha.cv = yy to replace beta/beta.cv if alternative
# expression of Weibull model is used.
mod.par <- list(fmax = 100, fmax.cv = 3, tlag = 0, tlag.cv = 0, 
                mdt = 20, mdt.cv = 25, beta = 2, beta.cv = 30)
```


### Example with multivariate normal distribution

```{r mvn01-dat}
# target mean profile 
dp <- c(39, 63, 77, 86, 95, 98, 100)

# CV at each time points
dp.cv <- c(19, 15, 10, 8, 8, 5, 3)

mvn.dat <- sim.dp(tp, dp = dp, dp.cv = dp.cv, seed = 123)
mvn.dat$sim.summary
```
Notice that the the mean and CV of the simulated individual profile (
`sim.mean` and `sim.cv`) are equal to the target profile `dp` and `dp.cv`.
The plot look like this:

```{r mvn01-plot}
mvn.dat$sim.plot
```

Another example with missing `dp.cv`.
```{r mvn02-dat}
mvn.dat2 <- sim.dp(tp, dp = dp, seed = 100)
mvn.dat2$sim.summary
```
Notice that the CVs were generated automatically as explained in
[Notes on function arguments].

As [explained above][Notes on function arguments], sometimes the
profiles will *decrease* toward the end, especially when the target 
profile is fast and the variability is high. 

```{r mvn03-dat}
dp.fast <- c(50, 74, 84, 87, 92, 97, 99)
dp2.cv <- c(15, 15, 10, 10, 10, 10, 5)
tmp2 <- sim.dp(tp, dp = dp.fast, dp.cv = dp2.cv, seed = 123)
tmp2$sim.plot
```
Notice the downward trend from 45 min to 60 min for some individual 
profiles. Check the individual values for unit 1, 2, 5, 6, etc. 


```{r mvn03-disso}
tmp2$sim.disso
```


